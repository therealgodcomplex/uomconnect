<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>UoMConnect</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#00040f;--card:#070d1f;--card2:#0b1428;
  --accent:#0a84ff;--al:#4facfe;--al2:#a8d8ff;
  --border:#1a2744;--border2:#243660;
  --text:#f0f6ff;--text2:#b8cef0;--muted:#5a7aaa;
  --green:#30d158;--red:#ff453a;--yellow:#ffd60a;
  --orange:#ff9f0a;--purple:#bf5af2;--teal:#5ac8fa;
}
html,body{height:100%;background:#000;overflow:hidden}
body{display:flex;align-items:center;justify-content:center;font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display','Segoe UI',sans-serif}
.amb{position:fixed;border-radius:50%;filter:blur(90px);opacity:.13;pointer-events:none}
.a1{width:500px;height:500px;background:var(--accent);top:-120px;left:-120px}
.a2{width:400px;height:400px;background:var(--purple);bottom:-100px;right:-100px}
.a3{width:280px;height:280px;background:var(--teal);top:40%;left:35%}
#ph{width:393px;height:852px;background:var(--bg);border-radius:52px;overflow:hidden;display:flex;flex-direction:column;position:relative;
  border:1px solid rgba(255,255,255,.07);
  box-shadow:0 0 0 .5px rgba(255,255,255,.09),0 0 80px rgba(10,132,255,.35),0 0 160px rgba(10,132,255,.13),0 50px 100px rgba(0,0,0,.8),inset 0 1px 0 rgba(255,255,255,.1)}
#di{position:absolute;top:14px;left:50%;transform:translateX(-50%);width:126px;height:37px;background:#000;border-radius:20px;z-index:999;display:flex;align-items:center;justify-content:space-between;padding:0 14px;box-shadow:0 0 0 1px rgba(255,255,255,.05)}
.di-cam{width:12px;height:12px;border-radius:50%;background:#111;border:1px solid #2a2a2a}
.di-s{width:8px;height:8px;border-radius:50%;background:#111}
#sb{padding:56px 26px 8px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.sb-t{font-size:17px;font-weight:600;color:var(--text);letter-spacing:-.3px}
.sb-r{display:flex;align-items:center;gap:5px;font-size:12px;color:var(--text)}
#hdr{padding:2px 22px 12px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.pg-title{font-size:34px;font-weight:800;letter-spacing:-.8px;background:linear-gradient(135deg,#fff 0%,var(--al) 50%,var(--accent) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.pg-sub{font-size:13px;color:var(--muted);margin-top:1px}
.av-btn{width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--purple));display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px;color:#fff;box-shadow:0 0 0 2px rgba(10,132,255,.3),0 0 18px rgba(10,132,255,.4);cursor:pointer;flex-shrink:0}
#mtabs{padding:0 20px 10px;display:flex;gap:7px;overflow-x:auto;flex-shrink:0;scrollbar-width:none}
#mtabs::-webkit-scrollbar{display:none}
.mt{background:var(--card);border:.5px solid var(--border);border-radius:999px;padding:6px 14px;color:var(--muted);font-size:12px;font-weight:500;cursor:pointer;white-space:nowrap;transition:all .18s}
.mt.on{background:rgba(10,132,255,.15);border-color:rgba(10,132,255,.4);color:var(--al);box-shadow:0 0 10px rgba(10,132,255,.2)}
#screens{flex:1;overflow:hidden;position:relative}
.scr{position:absolute;inset:0;overflow-y:auto;display:none;scrollbar-width:none}
.scr::-webkit-scrollbar{display:none}
.scr.on{display:block}
.pad{padding:0 18px 90px}
#s-map{padding:0}
#nav{flex-shrink:0;background:rgba(7,13,31,.88);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border-top:.5px solid rgba(255,255,255,.07);padding:10px 0 26px;display:flex;justify-content:space-around;position:relative}
.nb{display:flex;flex-direction:column;align-items:center;gap:3px;background:none;border:none;cursor:pointer;padding:2px 10px;transition:all .18s cubic-bezier(.34,1.56,.64,1)}
.nb .ni{font-size:22px;transition:transform .2s cubic-bezier(.34,1.56,.64,1)}
.nb .nl{font-size:10px;font-weight:500;color:var(--muted);transition:color .15s}
.nb.on .ni{transform:scale(1.12)}
.nb.on .nl{color:var(--accent)}
.nb .nd{width:20px;height:2.5px;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--teal));box-shadow:0 0 6px var(--accent);opacity:0;transition:opacity .15s;margin-top:1px}
.nb.on .nd{opacity:1}
.card{background:var(--card);border-radius:20px;border:.5px solid var(--border);overflow:hidden}
.ci{padding:16px}
.cg{box-shadow:0 4px 24px rgba(10,132,255,.1)}
.sh{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:12px}
.st{font-size:22px;font-weight:700;color:var(--text);letter-spacing:-.4px}
.sl{font-size:14px;color:var(--accent);font-weight:500;cursor:pointer}
.lr{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:.5px solid rgba(255,255,255,.05)}
.lr:last-child{border:none}
.lic{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.lb{flex:1;min-width:0}
.lt{font-size:15px;font-weight:500;color:var(--text);letter-spacing:-.2px}
.ls{font-size:13px;color:var(--muted);margin-top:1px}
.lrt{flex-shrink:0;display:flex;flex-direction:column;align-items:flex-end;gap:3px}
.ltime{font-size:12px;color:var(--muted)}
.inp{background:var(--card2);border:.5px solid var(--border2);border-radius:12px;padding:13px 16px;color:var(--text);font-size:16px;font-family:inherit;outline:none;width:100%;transition:border-color .2s}
.inp:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(10,132,255,.12)}
.inp::placeholder{color:var(--muted)}
select.inp{cursor:pointer}
textarea.inp{resize:none;line-height:1.5}
.pbtn{background:var(--accent);border:none;border-radius:999px;padding:10px 20px;color:#fff;font-weight:600;font-size:14px;cursor:pointer;box-shadow:0 0 16px rgba(10,132,255,.5);transition:opacity .15s;letter-spacing:-.1px}
.pbtn:active{opacity:.8}
.pbtn.full{width:100%;border-radius:14px;padding:14px;font-size:15px}
.sbtn{background:rgba(10,132,255,.12);border:.5px solid rgba(10,132,255,.3);border-radius:999px;padding:10px 20px;color:var(--al);font-weight:600;font-size:14px;cursor:pointer;transition:opacity .15s}
.sg{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.sw{border-radius:20px;padding:16px;border:.5px solid;position:relative;overflow:hidden}
.sn{font-size:38px;font-weight:800;letter-spacing:-1px;line-height:1}
.sl2{font-size:12px;font-weight:500;opacity:.7;margin-top:4px}
.sw-bg{position:absolute;top:-20px;right:-20px;width:80px;height:80px;border-radius:50%;opacity:.08}
.sc-t{width:52px;flex-shrink:0}
.sc-time{font-size:13px;font-weight:600;color:var(--accent)}
.sc-end{font-size:11px;color:var(--muted)}
.sc-bar{width:3px;flex-shrink:0;align-self:stretch;margin:2px 0;border-radius:99px;overflow:hidden}
.bdg{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:999px;font-size:11px;font-weight:600}
.ud{width:8px;height:8px;border-radius:50%;flex-shrink:0}
@keyframes upulse{0%,100%{box-shadow:0 0 0 0 currentColor}50%{box-shadow:0 0 6px 2px currentColor}}
.ud.urg{animation:upulse 1.5s infinite}
.ptag{font-size:11px;font-weight:600;padding:2px 8px;border-radius:999px}
.ring-w{position:relative;width:160px;height:160px;margin:0 auto}
.ring-w svg{transform:rotate(-90deg)}
.ring-ov{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.gpa-n{font-size:44px;font-weight:800;letter-spacing:-1.5px;color:var(--al);text-shadow:0 0 20px rgba(10,132,255,.6)}
.gpa-l{font-size:12px;color:var(--muted);font-weight:500}
.prog{background:rgba(255,255,255,.06);border-radius:999px;height:6px;overflow:hidden}
.pf{height:100%;border-radius:999px;transition:width .5s cubic-bezier(.4,0,.2,1)}
.fav{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px;color:#fff;flex-shrink:0}
.nc{border-radius:20px;padding:16px;border:.5px solid;margin-bottom:12px;position:relative;overflow:hidden}
.cg2{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;text-align:center}
.chdr{font-size:12px;font-weight:600;color:var(--muted);padding:4px 0}
.cday{padding:4px 2px;border-radius:9px;cursor:pointer}
.cday.tod{background:var(--accent);border-radius:50%;width:32px;height:32px;display:flex;flex-direction:column;align-items:center;justify-content:center;margin:auto}
.cday.tod .cdn{color:#fff;font-weight:700}
.cdn{font-size:13px;color:var(--text);line-height:1.4}
.cdots{display:flex;justify-content:center;gap:2px;margin-top:1px}
.cdot{width:4px;height:4px;border-radius:50%}
.pav{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--purple));display:flex;align-items:center;justify-content:center;font-size:30px;font-weight:800;color:#fff;margin:0 auto 12px;box-shadow:0 0 0 4px rgba(10,132,255,.2),0 0 30px rgba(10,132,255,.4)}
#mw{position:relative;width:100%;height:100%;overflow:hidden;background:#000510;cursor:grab}
#mw.drg{cursor:grabbing}
#mc{position:absolute;top:0;left:0;transform-origin:0 0}
.pin{position:absolute;transform:translate(-50%,-100%);cursor:pointer;z-index:100}
.pin:hover .pb,.pin.act .pb{transform:rotate(-45deg) scale(1.22)!important}
.pin.act .pb{border-color:rgba(255,255,255,.85)!important}
.pb{width:26px;height:26px;border-radius:50% 50% 50% 0;transform:rotate(-45deg);display:flex;align-items:center;justify-content:center;border:1.5px solid rgba(255,255,255,.3);transition:transform .15s}
.pb span{transform:rotate(45deg);font-size:12px;display:block;line-height:1}
.pt{width:5px;height:5px;border-radius:50%;margin:-1px auto 0}
#rsvg{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:50}
#ms-wrap{position:absolute;top:56px;left:10px;right:10px;z-index:300}
.ms-inner{background:rgba(7,13,31,.9);backdrop-filter:blur(20px);border:.5px solid var(--border2);border-radius:13px;display:flex;align-items:center;gap:8px;padding:10px 13px}
.ms-inner input{background:none;border:none;color:var(--text);font-size:15px;font-family:inherit;outline:none;flex:1}
.ms-inner input::placeholder{color:var(--muted)}
#msr{position:absolute;top:calc(100%+5px);left:0;right:0;background:rgba(7,13,31,.97);backdrop-filter:blur(16px);border:.5px solid var(--border2);border-radius:13px;display:none;overflow:hidden;z-index:400}
#msr.on{display:block}
.msri{padding:11px 14px;font-size:14px;cursor:pointer;border-bottom:.5px solid rgba(255,255,255,.05);color:var(--text2);display:flex;align-items:center;gap:10px}
.msri:hover{background:rgba(255,255,255,.04)}
#mf{position:absolute;top:108px;left:0;right:0;z-index:200;display:flex;gap:6px;padding:0 10px;overflow-x:auto;scrollbar-width:none}
#mf::-webkit-scrollbar{display:none}
.mfb{background:rgba(7,13,31,.82);backdrop-filter:blur(10px);border:.5px solid rgba(255,255,255,.1);border-radius:999px;padding:5px 13px;color:var(--muted);font-size:11px;font-weight:500;cursor:pointer;white-space:nowrap}
.mfb.on{background:rgba(10,132,255,.22);border-color:rgba(10,132,255,.5);color:var(--al)}
#mctrl{position:absolute;right:10px;top:56px;z-index:300;display:flex;flex-direction:column;gap:6px}
.mcb{width:36px;height:36px;background:rgba(7,13,31,.9);backdrop-filter:blur(16px);border:.5px solid var(--border2);border-radius:11px;color:var(--al);font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.mcb:active{transform:scale(.9)}
#rbar{position:absolute;bottom:0;left:50%;transform:translateX(-50%);background:rgba(7,13,31,.92);backdrop-filter:blur(20px);border:.5px solid rgba(10,132,255,.35);border-radius:18px 18px 0 0;padding:14px 24px 22px;z-index:500;display:none;gap:22px;align-items:center;box-shadow:0 -4px 24px rgba(10,132,255,.2)}
#rbar.on{display:flex}
#mbs{position:absolute;bottom:0;left:0;right:0;background:rgba(7,13,31,.96);backdrop-filter:blur(24px);border-radius:24px 24px 0 0;border-top:.5px solid rgba(255,255,255,.09);z-index:400;transform:translateY(100%);transition:transform .32s cubic-bezier(.4,0,.2,1);max-height:62%}
#mbs.on{transform:translateY(0)}
#mbsh{width:36px;height:4px;background:rgba(255,255,255,.14);border-radius:99px;margin:9px auto 0}
#mbsc{overflow-y:auto;padding:13px 18px 28px;max-height:calc(62vh - 30px);scrollbar-width:none}
#adm{position:absolute;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(8px);z-index:600;display:none;align-items:flex-end}
#adm.on{display:flex}
#admp{background:var(--card);border-radius:24px 24px 0 0;border-top:.5px solid rgba(255,255,255,.1);padding:20px 20px 38px;width:100%;max-height:78%;overflow-y:auto}
.spin{width:20px;height:20px;border:2px solid rgba(10,132,255,.2);border-top-color:var(--accent);border-radius:50%;animation:sp .6s linear infinite;margin:20px auto}
@keyframes sp{to{transform:rotate(360deg)}}
#toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:rgba(10,132,255,.9);color:#fff;padding:10px 20px;border-radius:999px;font-size:13px;font-weight:600;opacity:0;pointer-events:none;transition:opacity .25s;z-index:9999;white-space:nowrap}
#toast.on{opacity:1}
</style>
</head>
<body>
<div class="amb a1"></div>
<div class="amb a2"></div>
<div class="amb a3"></div>
<div id="toast"></div>

<div id="ph">
  <div id="di"><div class="di-cam"></div><div style="display:flex;gap:4px"><div class="di-s"></div><div class="di-s" style="width:6px;height:6px;margin-top:1px"></div></div></div>

  <div id="sb"><span class="sb-t" id="clk">9:41</span><div class="sb-r"><span>ğŸ“¶</span><span>ğŸ”‹</span></div></div>

  <div id="hdr">
    <div><div class="pg-title" id="ptitle">Home</div><div class="pg-sub" id="psub">Monday, 23 Feb</div></div>
    <div class="av-btn" onclick="go('profile')">A</div>
  </div>

  <div id="mtabs">
    <button class="mt" data-s="gpa" onclick="go('gpa')">ğŸ“Š GPA</button>
    <button class="mt" data-s="complaints" onclick="go('complaints')">ğŸ“ Help</button>
    <button class="mt" data-s="map" onclick="go('map')">ğŸ—º Map</button>
    <button class="mt" data-s="profile" onclick="go('profile')">ğŸ‘¤ Profile</button>
  </div>

  <div id="screens">

    <!-- HOME -->
    <div class="scr on" id="s-home"><div class="pad">
      <div class="sg">
        <div class="sw" style="background:rgba(10,132,255,.08);border-color:rgba(10,132,255,.2)"><div class="sw-bg" style="background:var(--accent)"></div><div style="font-size:11px;font-weight:600;color:var(--accent);letter-spacing:.5px;text-transform:uppercase">Classes</div><div class="sn" style="color:var(--accent)">4</div><div class="sl2" style="color:var(--text2)">Today</div></div>
        <div class="sw" style="background:rgba(255,69,58,.08);border-color:rgba(255,69,58,.2)"><div class="sw-bg" style="background:var(--red)"></div><div style="font-size:11px;font-weight:600;color:var(--red);letter-spacing:.5px;text-transform:uppercase">Due</div><div class="sn" style="color:var(--red)">1</div><div class="sl2" style="color:var(--text2)">Today</div></div>
        <div class="sw" style="background:rgba(255,214,10,.08);border-color:rgba(255,214,10,.2)"><div class="sw-bg" style="background:var(--yellow)"></div><div style="font-size:11px;font-weight:600;color:var(--yellow);letter-spacing:.5px;text-transform:uppercase">Tasks</div><div class="sn" style="color:var(--yellow)">3</div><div class="sl2" style="color:var(--text2)">This week</div></div>
        <div class="sw" style="background:rgba(90,200,250,.08);border-color:rgba(90,200,250,.2)"><div class="sw-bg" style="background:var(--teal)"></div><div style="font-size:11px;font-weight:600;color:var(--teal);letter-spacing:.5px;text-transform:uppercase">Notices</div><div class="sn" style="color:var(--teal)" id="notice-count">5</div><div class="sl2" style="color:var(--text2)">Unread</div></div>
      </div>
      <div class="sh"><span class="st">Today</span><span class="sl" onclick="go('calendar')">See all</span></div>
      <div class="card cg"><div class="ci">
        <div class="lr"><div class="sc-t"><div class="sc-time">08:00</div><div class="sc-end">09:30</div></div><div class="sc-bar"><div style="width:100%;height:100%;border-radius:99px;background:linear-gradient(to bottom,var(--accent),var(--teal))"></div></div><div class="lb"><div class="lt">Data Structures</div><div class="ls">LT-3 Â· Lecture</div></div><div class="lic" style="background:rgba(10,132,255,.12)">ğŸ’»</div></div>
        <div class="lr"><div class="sc-t"><div class="sc-time">10:00</div><div class="sc-end">11:30</div></div><div class="sc-bar"><div style="width:100%;height:100%;border-radius:99px;background:linear-gradient(to bottom,var(--purple),var(--accent))"></div></div><div class="lb"><div class="lt">Calculus II</div><div class="ls">LT-1 Â· Lecture</div></div><div class="lic" style="background:rgba(191,90,242,.12)">ğŸ“</div></div>
        <div class="lr"><div class="sc-t"><div class="sc-time">13:00</div><div class="sc-end">15:00</div></div><div class="sc-bar"><div style="width:100%;height:100%;border-radius:99px;background:linear-gradient(to bottom,var(--green),var(--teal))"></div></div><div class="lb"><div class="lt">Software Eng.</div><div class="ls">Lab-2 Â· Lab</div></div><div class="lic" style="background:rgba(48,209,88,.12)">âš™ï¸</div></div>
        <div class="lr"><div class="sc-t"><div class="sc-time">15:00</div><div class="sc-end">16:30</div></div><div class="sc-bar"><div style="width:100%;height:100%;border-radius:99px;background:linear-gradient(to bottom,var(--orange),var(--yellow))"></div></div><div class="lb"><div class="lt">Ethics in Tech</div><div class="ls">LT-5 Â· Tutorial</div></div><div class="lic" style="background:rgba(255,159,10,.12)">ğŸ“–</div></div>
      </div></div>
      <div class="sh" style="margin-top:18px"><span class="st">Deadlines</span></div>
      <div class="card"><div class="ci">
        <div class="lr"><div class="ud urg" style="color:var(--red);background:var(--red)"></div><div class="lb"><div class="lt">Data Structures Assignment 3</div><div class="ls">Today Â· 11:59 PM</div></div><div class="ptag" style="background:rgba(255,69,58,.12);color:var(--red)">URGENT</div></div>
        <div class="lr"><div class="ud urg" style="color:var(--red);background:var(--red)"></div><div class="lb"><div class="lt">Software Eng. Group Report</div><div class="ls">Tomorrow Â· 5:00 PM</div></div><div class="ptag" style="background:rgba(255,69,58,.12);color:var(--red)">URGENT</div></div>
        <div class="lr"><div class="ud" style="background:var(--yellow)"></div><div class="lb"><div class="lt">Calculus Problem Set</div><div class="ls">Feb 26</div></div><div style="font-size:12px;color:var(--muted)">3 days</div></div>
        <div class="lr"><div class="ud" style="background:var(--green)"></div><div class="lb"><div class="lt">Ethics Essay Draft</div><div class="ls">Mar 1</div></div><div style="font-size:12px;color:var(--muted)">6 days</div></div>
      </div></div>
      <div class="sh" style="margin-top:18px"><span class="st">Priority</span><span class="sl" onclick="go('notices')">All notices</span></div>
      <div style="background:linear-gradient(135deg,rgba(255,69,58,.1),rgba(255,69,58,.04));border:.5px solid rgba(255,69,58,.22);border-radius:20px;padding:14px;display:flex;gap:12px;align-items:center">
        <div class="lic" style="background:rgba(255,69,58,.14);width:44px;height:44px;border-radius:12px">âš ï¸</div>
        <div><div style="color:var(--text);font-size:15px;font-weight:600;letter-spacing:-.2px">Mid-Semester Exam Schedule Released</div><div style="color:var(--muted);font-size:13px;margin-top:2px">Tap Notices for full details</div></div>
      </div>
    </div></div>

    <!-- CALENDAR -->
    <div class="scr" id="s-calendar"><div class="pad">
      <div id="cal-filt" style="display:flex;gap:7px;flex-wrap:wrap;margin-bottom:14px">
        <button class="mt on" data-cf="All">All</button>
        <button class="mt" data-cf="Academic">Academic</button>
        <button class="mt" data-cf="Admin">Admin</button>
        <button class="mt" data-cf="Events">Events</button>
        <button class="mt" data-cf="Opportunities">Opportunities</button>
      </div>
      <div class="card cg"><div class="ci" id="calgrid"><div class="spin"></div></div></div>
      <div style="margin-top:16px"><div class="sh"><span class="st">Upcoming</span></div>
      <div class="card"><div class="ci" id="calevts"><div class="spin"></div></div></div></div>
    </div></div>

    <!-- NOTICES -->
    <div class="scr" id="s-notices"><div class="pad" id="notices-list"><div class="spin"></div></div></div>

    <!-- UMAIL -->
    <div class="scr" id="s-mail"><div class="pad">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
        <span style="background:rgba(10,132,255,.1);border:.5px solid rgba(10,132,255,.25);color:var(--al);font-size:12px;font-weight:500;padding:4px 12px;border-radius:999px">Google Workspace</span>
        <span style="color:var(--muted);font-size:13px">4 messages</span>
      </div>
      <div class="card"><div class="ci">
        <div class="lr" style="cursor:pointer" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display=='block'?'none':'block'">
          <div class="lic" style="background:rgba(255,69,58,.12)">ğŸ“¬</div>
          <div class="lb"><div class="lt">registrar@uom.ac.mu</div><div class="ls">Exam Registration Confirmation</div></div>
          <div class="lrt"><div class="ltime">9:12 AM</div><div class="ptag" style="background:rgba(255,69,58,.12);color:var(--red);font-size:10px">âš  DL</div></div>
        </div>
        <div style="display:none;margin:0 0 8px;padding:10px;background:var(--card2);border-radius:10px;font-size:12px;color:var(--muted);line-height:1.6">Full UMail integration requires OAuth with your @umail.uom.ac.mu account. Smart deadline extraction will auto-add events to your calendar.</div>
        <div class="lr" style="cursor:pointer" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display=='block'?'none':'block'">
          <div class="lic" style="background:rgba(10,132,255,.12)">ğŸ“©</div>
          <div class="lb"><div class="lt">cs.dept@uom.ac.mu</div><div class="ls">Assignment 3 Submission Guidelines</div></div>
          <div class="lrt"><div class="ltime">Yesterday</div><div class="ptag" style="background:rgba(255,69,58,.12);color:var(--red);font-size:10px">âš  DL</div></div>
        </div>
        <div style="display:none;margin:0 0 8px;padding:10px;background:var(--card2);border-radius:10px;font-size:12px;color:var(--muted);line-height:1.6">Deadline detection would auto-populate your calendar with the submission due date.</div>
        <div class="lr"><div class="lic" style="background:rgba(255,255,255,.04)">ğŸ“§</div><div class="lb"><div class="lt" style="color:var(--text2)">library@uom.ac.mu</div><div class="ls">Book Reservation Available</div></div><div class="ltime">Feb 21</div></div>
        <div class="lr"><div class="lic" style="background:rgba(255,255,255,.04)">ğŸ“§</div><div class="lb"><div class="lt" style="color:var(--text2)">careers@uom.ac.mu</div><div class="ls">Internship Fair â€” Register Now</div></div><div class="ltime">Feb 20</div></div>
      </div></div>
    </div></div>

    <!-- FORUMS -->
    <div class="scr" id="s-forums"><div class="pad">
      <div class="card" style="margin-bottom:14px;border-color:rgba(10,132,255,.2)"><div class="ci">
        <div style="display:flex;gap:10px;align-items:center">
          <div class="fav" style="background:linear-gradient(135deg,var(--accent),var(--teal))">A</div>
          <input class="inp" id="fi-title" placeholder="Start a discussionâ€¦" style="flex:1;font-size:14px;padding:10px 12px"/>
          <button class="pbtn" style="padding:10px 16px;font-size:13px" onclick="postForum()">Post</button>
        </div>
      </div></div>
      <div id="forum-list"><div class="spin"></div></div>
    </div></div>

    <!-- GPA -->
    <div class="scr" id="s-gpa"><div class="pad">
      <div class="card cg" style="border-color:rgba(10,132,255,.2)"><div class="ci" style="text-align:center;padding:22px 16px">
        <div class="ring-w">
          <svg width="160" height="160" viewBox="0 0 160 160">
            <circle cx="80" cy="80" r="68" fill="none" stroke="rgba(255,255,255,.05)" stroke-width="12"/>
            <circle id="garc" cx="80" cy="80" r="68" fill="none" stroke="url(#gg)" stroke-width="12" stroke-linecap="round" stroke-dasharray="427" stroke-dashoffset="107"/>
            <defs><linearGradient id="gg" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#0a84ff"/><stop offset="100%" stop-color="#5ac8fa"/></linearGradient></defs>
          </svg>
          <div class="ring-ov"><div class="gpa-n" id="gpa-n">3.50</div><div class="gpa-l">out of 4.00</div></div>
        </div>
        <div style="display:flex;justify-content:center;gap:20px;margin-top:16px">
          <div style="text-align:center"><div style="font-size:18px;font-weight:700;color:var(--green)" id="gpa-pct">87.5%</div><div style="font-size:11px;color:var(--muted)">Score</div></div>
          <div style="width:1px;background:var(--border)"></div>
          <div style="text-align:center"><div style="font-size:18px;font-weight:700;color:var(--yellow)">12cr</div><div style="font-size:11px;color:var(--muted)">Credits</div></div>
          <div style="width:1px;background:var(--border)"></div>
          <div style="text-align:center"><div style="font-size:18px;font-weight:700;color:var(--purple)" id="gpa-gap">0.20</div><div style="font-size:11px;color:var(--muted)">To Dean's</div></div>
        </div>
      </div></div>
      <div style="margin-top:16px"><div class="sh"><span class="st">Modules</span></div></div>
      <div id="gpa-mods" style="display:flex;flex-direction:column;gap:10px"></div>
      <div style="background:rgba(10,132,255,.06);border:.5px solid rgba(10,132,255,.18);border-radius:16px;padding:14px 16px;margin-top:12px;display:flex;gap:10px;align-items:center">
        <span style="font-size:20px">ğŸ’¡</span>
        <div style="font-size:13px;color:var(--al2);line-height:1.5">Dean's List requires â‰¥3.7 GPA. Aim for <strong>Aâˆ’</strong> or above in all modules.</div>
      </div>
    </div></div>

    <!-- COMPLAINTS -->
    <div class="scr" id="s-complaints"><div class="pad">
      <div class="card cg" style="margin-bottom:18px"><div class="ci">
        <div style="font-size:13px;color:var(--muted);font-weight:500;margin-bottom:10px">Your submission is completely anonymous</div>
        <textarea class="inp" id="ct" rows="4" placeholder="Describe your concern or suggestionâ€¦" style="margin-bottom:10px"></textarea>
        <select class="inp" id="ccat" style="margin-bottom:10px">
          <option value="General">General</option>
          <option value="Facilities">Facilities</option>
          <option value="Infrastructure">Infrastructure</option>
          <option value="Academic">Academic</option>
          <option value="Administration">Administration</option>
        </select>
        <button class="pbtn full" onclick="submitC()">Submit Anonymously</button>
        <div id="cconf" style="display:none;text-align:center;margin-top:10px;font-size:13px;color:var(--green);font-weight:500"></div>
      </div></div>
      <div class="sh"><span class="st">Track a Complaint</span></div>
      <div class="card" style="margin-bottom:18px"><div class="ci">
        <div style="display:flex;gap:8px">
          <input class="inp" id="cref-in" placeholder="Enter ref ID (e.g. C-ABC123)" style="flex:1;padding:10px 12px;font-size:14px"/>
          <button class="pbtn" style="padding:10px 16px;font-size:13px;white-space:nowrap" onclick="trackC()">Track</button>
        </div>
        <div id="ctrack-res" style="margin-top:10px"></div>
      </div></div>
      <div class="sh"><span class="st">My Submissions</span></div>
      <div id="c-list"><div class="spin"></div></div>
    </div></div>

    <!-- MAP -->
    <div class="scr" id="s-map">
      <div id="mw">
        <canvas id="mc"></canvas>
        <svg id="rsvg"></svg>
        <div id="ms-wrap">
          <div class="ms-inner"><span style="font-size:14px">ğŸ”</span><input id="msi" type="text" placeholder="Search buildings, officesâ€¦"/></div>
          <div id="msr"></div>
        </div>
        <div id="mf">
          <button class="mfb on" data-mc="All">All</button>
          <button class="mfb" data-mc="Admin">Admin</button>
          <button class="mfb" data-mc="Faculty">Faculty</button>
          <button class="mfb" data-mc="Library">Library</button>
          <button class="mfb" data-mc="Food">Food</button>
          <button class="mfb" data-mc="Sports">Sports</button>
          <button class="mfb" data-mc="Lecture">Lecture</button>
          <button class="mfb" data-mc="Services">Services</button>
          <button class="mfb" data-mc="Finance">Finance</button>
        </div>
        <div id="mctrl">
          <button class="mcb" onclick="dz(1.25)">ï¼‹</button>
          <button class="mcb" onclick="dz(.8)">ï¼</button>
          <button class="mcb" onclick="resetMap()">âŒ‚</button>
          <button class="mcb" onclick="openAdm()">âš™</button>
        </div>
        <div id="rbar">
          <div><div style="font-size:15px;font-weight:700;color:var(--al)" id="rdist">â€”</div><div style="font-size:11px;color:var(--muted)">Distance</div></div>
          <div><div style="font-size:15px;font-weight:700;color:var(--al)" id="rtime">â€”</div><div style="font-size:11px;color:var(--muted)">Walk time</div></div>
          <button style="background:rgba(255,255,255,.08);border:none;border-radius:50%;width:28px;height:28px;color:var(--text2);cursor:pointer;font-size:13px" onclick="clearRoute()">âœ•</button>
        </div>
        <div id="mbs"><div id="mbsh"></div><div id="mbsc"></div></div>
        <div id="adm"><div id="admp">
          <div style="font-size:18px;font-weight:700;color:var(--text);margin-bottom:14px;display:flex;justify-content:space-between;align-items:center">
            <span>âš™ Status Manager</span>
            <button onclick="closeAdm()" style="background:rgba(255,255,255,.08);border:none;border-radius:50%;width:30px;height:30px;color:var(--text2);cursor:pointer;font-size:16px">âœ•</button>
          </div>
          <select class="inp" id="admpoi" style="margin-bottom:10px"></select>
          <select class="inp" id="admstat" style="margin-bottom:10px"><option>OPEN</option><option>CLOSED</option><option>BUSY</option><option>QUIET</option><option>UNKNOWN</option></select>
          <input class="inp" id="admmsg" type="text" placeholder="Live messageâ€¦" style="margin-bottom:10px"/>
          <input class="inp" id="admtw" type="text" placeholder="Time window e.g. 14:00â€“16:00" style="margin-bottom:14px"/>
          <button class="pbtn full" style="font-size:15px;padding:14px" onclick="saveAdm()">Save Status Update</button>
          <div style="margin-top:16px;font-size:11px;font-weight:600;color:var(--muted);letter-spacing:.5px;text-transform:uppercase;margin-bottom:8px">Audit Trail</div>
          <div id="admlog"></div>
        </div></div>
      </div>
    </div>

    <!-- PROFILE -->
    <div class="scr" id="s-profile"><div class="pad">
      <div style="text-align:center;padding:16px 0 18px">
        <div class="pav">A</div>
        <div style="font-size:24px;font-weight:700;color:var(--text);letter-spacing:-.4px">Alex Johnson</div>
        <div style="font-size:14px;color:var(--muted);margin-top:3px">alex.johnson@umail.uom.ac.mu</div>
        <div style="display:inline-block;background:rgba(10,132,255,.12);border:.5px solid rgba(10,132,255,.3);color:var(--al);font-size:12px;font-weight:600;padding:4px 14px;border-radius:999px;margin-top:8px">Student</div>
      </div>
      <div class="card"><div class="ci">
        <div class="lr"><div class="lb"><div class="ls">Student ID</div><div class="lt">UOM-2023-0142</div></div></div>
        <div class="lr"><div class="lb"><div class="ls">Programme</div><div class="lt">BSc Computer Science</div></div></div>
        <div class="lr"><div class="lb"><div class="ls">Year</div><div class="lt">Year 2, Semester 2</div></div></div>
        <div class="lr"><div class="lb"><div class="ls">Faculty</div><div class="lt">Engineering</div></div></div>
        <div class="lr"><div class="lb"><div class="ls">Advisor</div><div class="lt">Dr. P. Ramlugun</div></div></div>
        <div class="lr"><div class="lb"><div class="ls">GPA</div><div class="lt" style="color:var(--green)">3.50 / 4.00</div></div></div>
      </div></div>
      <div style="margin-top:14px;background:linear-gradient(135deg,rgba(10,132,255,.12),rgba(191,90,242,.08));border:.5px solid rgba(10,132,255,.22);border-radius:20px;padding:18px">
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <div><div style="font-size:11px;font-weight:600;color:var(--al);text-transform:uppercase;letter-spacing:.5px">Digital ID</div><div style="font-size:18px;font-weight:700;color:var(--text);margin-top:4px">Alex Johnson</div><div style="font-size:13px;color:var(--muted)">UOM-2023-0142</div></div>
          <div style="width:56px;height:56px;background:rgba(255,255,255,.07);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:26px">ğŸ“</div>
        </div>
        <div style="margin-top:13px;background:rgba(0,0,0,.28);border-radius:10px;padding:12px;text-align:center">
          <div style="font-size:11px;color:var(--muted);margin-bottom:6px">QR rotates every 5 min</div>
          <div style="font-size:26px;letter-spacing:3px;color:var(--al2)">â–“â–’â–‘â–“â–’â–‘â–“</div>
          <div style="font-size:10px;color:var(--muted);margin-top:5px">Connect backend to generate live QR</div>
        </div>
      </div>
      <button style="width:100%;margin-top:14px;padding:14px;border-radius:16px;background:rgba(255,69,58,.07);border:.5px solid rgba(255,69,58,.2);color:var(--red);font-size:16px;font-weight:500;cursor:pointer">Sign Out</button>
    </div></div>

  </div><!-- /screens -->

  <div id="nav">
    <button class="nb on" data-s="home" onclick="go('home')"><span class="ni">ğŸ </span><span class="nl">Home</span><div class="nd"></div></button>
    <button class="nb" data-s="calendar" onclick="go('calendar')"><span class="ni">ğŸ“…</span><span class="nl">Calendar</span><div class="nd"></div></button>
    <button class="nb" data-s="notices" onclick="go('notices')"><span class="ni">ğŸ“¢</span><span class="nl">Notices</span><div class="nd"></div></button>
    <button class="nb" data-s="mail" onclick="go('mail')"><span class="ni">âœ‰ï¸</span><span class="nl">UMail</span><div class="nd"></div></button>
    <button class="nb" data-s="forums" onclick="go('forums')"><span class="ni">ğŸ’¬</span><span class="nl">Forums</span><div class="nd"></div></button>
  </div>
</div>

<script>
// â”€â”€ API CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API = window.location.origin === 'null' || window.location.origin === 'file://'
  ? 'http://localhost:4000'
  : window.location.origin;

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastTimer;
function toast(msg, dur=2500){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('on');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove('on'), dur);
}

// â”€â”€ CLOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tick(){
  const n=new Date();
  document.getElementById('clk').textContent=
    n.getHours().toString().padStart(2,'0')+':'+
    n.getMinutes().toString().padStart(2,'0');
}
tick(); setInterval(tick, 15000);

// â”€â”€ UTILITY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function timeAgo(d){
  const diff=(Date.now()-new Date(d))/1000;
  if(diff<60)return 'Just now';
  if(diff<3600)return Math.floor(diff/60)+'m ago';
  if(diff<86400)return Math.floor(diff/3600)+'h ago';
  return Math.floor(diff/86400)+'d ago';
}

// â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const meta={
  home:{t:'Home',s:'Monday, 23 Feb'},
  calendar:{t:'Calendar',s:'February 2026'},
  notices:{t:'Notices',s:'Latest announcements'},
  mail:{t:'UMail',s:'4 messages'},
  forums:{t:'Forums',s:'Study & Connect'},
  gpa:{t:'GPA',s:'Semester 2 Â· 2026'},
  complaints:{t:'Help',s:'Anonymous & secure'},
  map:{t:'Campus Map',s:'University of Mauritius'},
  profile:{t:'Profile',s:'alex.johnson@umail.uom.ac.mu'},
};
let mapReady=false;
function go(id){
  document.querySelectorAll('.scr').forEach(s=>s.classList.remove('on'));
  document.getElementById('s-'+id).classList.add('on');
  document.querySelectorAll('.nb').forEach(b=>b.classList.toggle('on',b.dataset.s===id));
  document.querySelectorAll('.mt').forEach(b=>b.classList.toggle('on',b.dataset.s===id));
  const m=meta[id]||{t:id,s:''};
  document.getElementById('ptitle').textContent=m.t;
  document.getElementById('psub').textContent=m.s;
  if(id==='calendar') loadCalendar();
  if(id==='notices') loadNotices();
  if(id==='forums') loadForums();
  if(id==='map'&&!mapReady){initMap(); mapReady=true;}
  if(id==='gpa') buildGPA();
  if(id==='complaints') loadComplaints();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTICES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const noticeColors={Exam:'#ff453a',Admin:'#ffd60a',Timetable:'#5ac8fa',Faculty:'#30d158',Registration:'#bf5af2',General:'#60a5fa'};

async function loadNotices(category=null){
  const el=document.getElementById('notices-list');
  el.innerHTML='<div class="spin"></div>';
  try{
    const url=new URL(`${API}/api/notices`);
    if(category) url.searchParams.set('category',category);
    const r=await fetch(url);
    const {data}=await r.json();
    if(!data.length){el.innerHTML='<div style="color:var(--muted);text-align:center;padding:30px">No notices yet</div>';return;}
    renderNoticeData(el,data);
    document.getElementById('notice-count').textContent=data.length;
  }catch(e){renderStaticNotices();}
}

function renderNoticeData(el,data){
  el.innerHTML=data.map(n=>{
    const c=noticeColors[n.category]||'#60a5fa';
    return `<div class="nc" style="background:${c}08;border-color:${c}22">
      <div style="position:absolute;top:0;left:0;bottom:0;width:3px;background:${c};border-radius:3px 0 0 3px"></div>
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
        <span style="background:${c}18;color:${c};border:.5px solid ${c}33;font-size:11px;font-weight:700;padding:2px 9px;border-radius:999px">${n.category}</span>
        <span style="color:var(--muted);font-size:12px">${timeAgo(n.created_at)}</span>
      </div>
      <div style="color:var(--text);font-size:15px;font-weight:600;letter-spacing:-.2px;margin-bottom:4px">${n.title}</div>
      <div style="color:var(--muted);font-size:13px;line-height:1.5">${n.body}</div>
    </div>`;
  }).join('');
}

function renderStaticNotices(){
  const el=document.getElementById('notices-list');
  const data=[
    {category:'Exam',title:'Mid-Semester Exam Schedule Released',body:'The mid-semester examination timetable is now available on the student portal.',created_at:new Date()},
    {category:'Admin',title:'Course Registration Opens March 1',body:'Log in to the student portal to register for your modules.',created_at:new Date(Date.now()-18000000)},
    {category:'Timetable',title:'CS101 Lecture Moved to LT-2 This Week',body:'Effective from Monday 23 Feb for this week only.',created_at:new Date(Date.now()-86400000)},
    {category:'Faculty',title:'Guest Lecture: AI in Healthcare â€” Feb 28',body:'POWA Auditorium, 10:00â€“12:00. All students welcome.',created_at:new Date(Date.now()-86400000)},
    {category:'Registration',title:'Add/Drop Deadline: February 28',body:'Final date to add or drop modules for Semester 2.',created_at:new Date(Date.now()-172800000)},
  ];
  renderNoticeData(el,data);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALENDAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const calC={Academic:'#0a84ff',Admin:'#ffd60a',Events:'#30d158',Opportunities:'#bf5af2',Today:'#ff375f'};
let calFilter='All';

async function loadCalendar(){
  document.getElementById('calgrid').innerHTML='<div class="spin"></div>';
  document.getElementById('calevts').innerHTML='<div class="spin"></div>';
  try{
    const url=new URL(`${API}/api/calendar`);
    url.searchParams.set('month','2'); url.searchParams.set('year','2026');
    if(calFilter!=='All') url.searchParams.set('category',calFilter);
    const r=await fetch(url);
    const evts=await r.json();
    renderCalGrid(evts); renderCalEvents(evts);
  }catch(e){renderStaticCalendar();}
}

function renderCalGrid(evts){
  const byDay={};
  evts.forEach(e=>{const d=new Date(e.event_date).getUTCDate(); if(!byDay[d])byDay[d]=[]; byDay[d].push(e);});
  const days=['Su','Mo','Tu','We','Th','Fr','Sa'];
  let h=`<div style="font-size:17px;font-weight:600;color:var(--text);letter-spacing:-.3px;margin-bottom:12px">February 2026</div><div class="cg2">`;
  days.forEach(d=>h+=`<div class="chdr">${d}</div>`);
  // Feb 2026 starts on Sunday (offset 0)
  for(let i=0;i<28;i++){
    const day=i+1, isT=day===23, de=byDay[day]||[];
    h+=`<div class="cday${isT?' tod':''}"><div class="cdn">${day}</div><div class="cdots">${de.slice(0,3).map(e=>`<div class="cdot" style="background:${calC[e.category]||'#0a84ff'}"></div>`).join('')}</div></div>`;
  }
  document.getElementById('calgrid').innerHTML=h+`</div>`;
}

function renderCalEvents(evts){
  if(!evts.length){document.getElementById('calevts').innerHTML='<div style="color:var(--muted);text-align:center;padding:20px">No events</div>';return;}
  document.getElementById('calevts').innerHTML=evts.map(e=>{
    const c=calC[e.category]||'#0a84ff';
    const d=new Date(e.event_date);
    const dl=d.toLocaleDateString('en-GB',{day:'numeric',month:'short',timeZone:'UTC'});
    return `<div class="lr"><div style="width:46px;font-size:12px;font-weight:600;color:var(--accent);flex-shrink:0">${dl}</div><div class="lb"><div class="lt">${e.title}</div>${e.description?`<div class="ls">${e.description}</div>`:''}</div><span style="font-size:11px;font-weight:600;padding:2px 8px;border-radius:999px;background:${c}18;color:${c};border:.5px solid ${c}33;flex-shrink:0">${e.category}</span></div>`;
  }).join('');
}

function renderStaticCalendar(){
  const evts=[
    {event_date:'2026-02-23',title:'Data Structures Assignment 3 Due',category:'Academic'},
    {event_date:'2026-02-24',title:'Software Engineering Group Report Due',category:'Academic'},
    {event_date:'2026-02-26',title:'Calculus II Problem Set Due',category:'Academic'},
    {event_date:'2026-02-28',title:'Add/Drop Module Deadline',category:'Admin'},
    {event_date:'2026-02-28',title:'Guest Lecture: AI in Healthcare',category:'Events'},
    {event_date:'2026-03-01',title:'Course Registration Opens',category:'Admin'},
    {event_date:'2026-03-05',title:'Mid-Semester Examinations Begin',category:'Academic'},
    {event_date:'2026-03-10',title:'UoM Career Fair 2026',category:'Opportunities'},
  ];
  renderCalGrid(evts); renderCalEvents(evts);
}

document.getElementById('cal-filt').addEventListener('click',e=>{
  const b=e.target.closest('[data-cf]'); if(!b)return;
  document.querySelectorAll('[data-cf]').forEach(x=>x.classList.remove('on'));
  b.classList.add('on'); calFilter=b.dataset.cf; loadCalendar();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORUMS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const tagC={Academic:'rgba(10,132,255,.12)',Career:'rgba(48,209,88,.12)','Study Group':'rgba(90,200,250,.12)',General:'rgba(255,159,10,.12)',Announcement:'rgba(191,90,242,.12)'};
const tagTxt={Academic:'#4facfe',Career:'#30d158','Study Group':'#5ac8fa',General:'#ff9f0a',Announcement:'#bf5af2'};
const roleColors={Senior:'#ffd60a',Alumni:'#30d158',Staff:'#bf5af2',Admin:'#ff453a',Student:'#4facfe'};
const avatarBgs=['linear-gradient(135deg,#0a84ff,#5ac8fa)','linear-gradient(135deg,#bf5af2,#0a84ff)','linear-gradient(135deg,#ff375f,#bf5af2)','linear-gradient(135deg,#30d158,#5ac8fa)','linear-gradient(135deg,#ff9f0a,#ffd60a)'];

async function loadForums(){
  const el=document.getElementById('forum-list');
  el.innerHTML='<div class="spin"></div>';
  try{
    const r=await fetch(`${API}/api/forums`);
    const posts=await r.json();
    renderForums(posts);
  }catch(e){renderStaticForums();}
}

function renderForums(posts){
  const el=document.getElementById('forum-list');
  if(!posts.length){el.innerHTML='<div style="color:var(--muted);text-align:center;padding:30px">No posts yet. Start a discussion!</div>';return;}
  el.innerHTML=posts.map((p,i)=>`
    <div class="card" style="margin-bottom:10px;cursor:pointer" onclick="openPost('${p.id}')">
      <div class="ci"><div style="display:flex;gap:12px">
        <div class="fav" style="background:${avatarBgs[i%avatarBgs.length]}">${(p.author_name||'A')[0].toUpperCase()}</div>
        <div style="flex:1">
          <div style="display:flex;justify-content:space-between;align-items:flex-start">
            <div><div style="font-size:13px;font-weight:600;color:${roleColors[p.author_role]||'var(--al)'}">${p.author_name}</div><div style="font-size:11px;color:var(--muted)">${p.author_role}</div></div>
            <span style="font-size:11px;color:var(--muted)">${timeAgo(p.created_at)}</span>
          </div>
          <div style="color:var(--text);font-size:15px;font-weight:500;margin-top:6px;letter-spacing:-.2px">${p.title}</div>
          ${p.body?`<div style="color:var(--muted);font-size:13px;margin-top:3px;line-height:1.4;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical">${p.body}</div>`:''}
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <span style="background:${tagC[p.tag]||tagC.General};color:${tagTxt[p.tag]||tagTxt.General};border:.5px solid ${tagTxt[p.tag]||tagTxt.General}33;font-size:11px;font-weight:600;padding:2px 9px;border-radius:999px">${p.tag||'General'}</span>
            <span style="color:var(--muted);font-size:12px">ğŸ’¬ ${p.reply_count||0} ${p.reply_count===1?'reply':'replies'}</span>
          </div>
        </div>
      </div></div>
    </div>`).join('');
}

function renderStaticForums(){
  renderForums([
    {id:'a',author_name:'Sarah M.',author_role:'Senior',title:'Tips for surviving Data Structures â€” from someone who failed it once',body:"Don't just memorise algorithms, understand WHY they work.",tag:'Academic',reply_count:14,created_at:new Date(Date.now()-3600000)},
    {id:'b',author_name:'Raj K.',author_role:'Alumni',title:'Internship at MCB â€” honest review and tips to get in',body:'The application opens around November on their careers portal.',tag:'Career',reply_count:8,created_at:new Date(Date.now()-10800000)},
    {id:'c',author_name:'Aisha T.',author_role:'Student',title:'Study group for Calculus II â€” anyone want to join?',body:'Planning to meet at Library Group Study Room 2, Tuesdays and Thursdays.',tag:'Study Group',reply_count:22,created_at:new Date(Date.now()-18000000)},
    {id:'d',author_name:'Student Union',author_role:'Admin',title:'UoM Career Fair 2026 â€” Companies Confirmed',body:'MCB, Accenture, Rogers Capital, Air Mauritius, Mauritius Telecom + 35 more.',tag:'Announcement',reply_count:5,created_at:new Date(Date.now()-86400000)},
  ]);
}

async function postForum(){
  const title=document.getElementById('fi-title').value.trim();
  if(!title)return;
  try{
    const r=await fetch(`${API}/api/forums`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({title,body:'',tag:'General',author_name:'You',author_role:'Student'})
    });
    const post=await r.json();
    if(post.error) throw new Error(post.error);
    document.getElementById('fi-title').value='';
    toast('âœ… Post published!');
    loadForums();
  }catch(e){
    toast('âš  Could not post â€” added locally');
    const el=document.getElementById('forum-list');
    const d=document.createElement('div');
    d.className='card'; d.style.marginBottom='10px';
    d.innerHTML=`<div class="ci"><div style="display:flex;gap:12px"><div class="fav" style="background:linear-gradient(135deg,var(--green),var(--teal))">Y</div><div style="flex:1"><div style="color:var(--al);font-size:13px;font-weight:600">You Â· Student</div><div style="color:var(--text);font-size:15px;font-weight:500;margin-top:5px">${title}</div><div style="margin-top:7px;color:var(--muted);font-size:12px">ğŸ’¬ 0 replies</div></div></div></div>`;
    el.prepend(d);
    document.getElementById('fi-title').value='';
  }
}

async function openPost(id){
  if(id.length<10) return;
  try{
    const r=await fetch(`${API}/api/forums/${id}/replies`);
    const replies=await r.json();
    toast(`ğŸ’¬ ${replies.length} replies loaded`);
  }catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPLAINTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function submitC(){
  const content=document.getElementById('ct').value.trim();
  const category=document.getElementById('ccat').value;
  if(!content){toast('âš  Please describe your concern');return;}
  const btn=document.querySelector('#s-complaints .pbtn.full');
  btn.textContent='Submittingâ€¦'; btn.disabled=true;
  try{
    const r=await fetch(`${API}/api/complaints`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({content,category})
    });
    const data=await r.json();
    if(data.error) throw new Error(data.error);
    document.getElementById('ct').value='';
    document.getElementById('cconf').textContent=`âœ… Submitted anonymously Â· Reference: ${data.ref_id}`;
    document.getElementById('cconf').style.display='block';
    toast('âœ… Complaint submitted!');
    setTimeout(()=>document.getElementById('cconf').style.display='none',5000);
    loadComplaints();
  }catch(e){
    const ref='C-'+Date.now().toString(36).toUpperCase();
    document.getElementById('cconf').textContent=`âœ… Submitted Â· Ref: ${ref} (offline)`;
    document.getElementById('cconf').style.display='block';
    document.getElementById('ct').value='';
    setTimeout(()=>document.getElementById('cconf').style.display='none',5000);
  }finally{btn.textContent='Submit Anonymously'; btn.disabled=false;}
}

async function trackC(){
  const ref=document.getElementById('cref-in').value.trim().toUpperCase();
  if(!ref){toast('âš  Enter a reference ID');return;}
  const el=document.getElementById('ctrack-res');
  el.innerHTML='<div class="spin" style="margin:10px auto"></div>';
  try{
    const r=await fetch(`${API}/api/complaints/${ref}`);
    if(!r.ok) throw new Error('not found');
    const d=await r.json();
    const sc={SUBMITTED:'#ffd60a',IN_REVIEW:'#5ac8fa',RESOLVED:'#30d158',CLOSED:'#636366'};
    el.innerHTML=`<div style="background:rgba(255,255,255,.04);border-radius:12px;padding:12px;border:.5px solid var(--border2)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <span style="color:var(--text);font-weight:600">${d.ref_id}</span>
        <span style="background:${sc[d.status]||'#636366'}18;color:${sc[d.status]||'#636366'};border:.5px solid ${sc[d.status]||'#636366'}33;font-size:11px;font-weight:700;padding:2px 9px;border-radius:999px">${d.status}</span>
      </div>
      ${d.admin_response?`<div style="color:var(--muted);font-size:13px;margin-top:4px">ğŸ’¬ ${d.admin_response}</div>`:'<div style="color:var(--muted);font-size:13px">Awaiting admin response</div>'}
    </div>`;
  }catch(e){el.innerHTML='<div style="color:var(--muted);font-size:13px;padding:8px">Reference ID not found</div>';}
}

async function loadComplaints(){
  document.getElementById('c-list').innerHTML=`
    <div class="card"><div class="ci">
      <div class="lr"><div class="lic" style="background:rgba(255,159,10,.1)">ğŸ“‹</div><div class="lb"><div class="lt">Canteen food quality</div><div class="ls">C-SEED001 Â· Feb 18</div></div><div class="ptag" style="background:rgba(255,159,10,.12);color:var(--orange)">In Review</div></div>
      <div class="lr"><div class="lic" style="background:rgba(48,209,88,.1)">âœ…</div><div class="lb"><div class="lt">WiFi issues in Block C</div><div class="ls">C-SEED002 Â· Feb 10</div></div><div class="ptag" style="background:rgba(48,209,88,.12);color:var(--green)">Resolved</div></div>
    </div></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GPA CALCULATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const gMap={'A+':4,'A':4,'A-':3.7,'B+':3.3,'B':3,'B-':2.7,'C+':2.3,'C':2,'D':1,'F':0};
const gList=['A+','A','A-','B+','B','B-','C+','C','D','F'];
let mods=[
  {n:'Data Structures',cr:3,g:'A'},
  {n:'Calculus II',cr:3,g:'B+'},
  {n:'Software Engineering',cr:4,g:'A-'},
  {n:'Ethics in Tech',cr:2,g:'B'}
];

function calcGPA(){
  const t=mods.reduce((s,m)=>s+(gMap[m.g]||0)*m.cr,0);
  const c=mods.reduce((s,m)=>s+m.cr,0);
  return c?(t/c).toFixed(2):'0.00';
}

function buildGPA(){
  const g=parseFloat(calcGPA());
  const col=g>=3.7?'var(--green)':g>=3.0?'var(--al)':'var(--yellow)';
  document.getElementById('gpa-n').textContent=g.toFixed(2);
  document.getElementById('gpa-n').style.color=col;
  document.getElementById('gpa-n').style.textShadow=`0 0 20px ${col}`;
  document.getElementById('garc').setAttribute('stroke-dashoffset',Math.round(427*(1-g/4)));
  document.getElementById('gpa-pct').textContent=(g/4*100).toFixed(1)+'%';
  document.getElementById('gpa-gap').textContent=Math.max(0,3.7-g).toFixed(2);
  const w=document.getElementById('gpa-mods'); w.innerHTML='';
  mods.forEach((m,i)=>{
    const d=document.createElement('div');
    d.className='card';
    d.innerHTML=`<div class="ci" style="display:flex;justify-content:space-between;align-items:center">
      <div><div class="lt">${m.n}</div><div class="ls">${m.cr} credits</div></div>
      <select class="inp" style="width:82px;text-align:center;color:var(--al);font-weight:600;font-size:16px;padding:8px 6px;border-color:rgba(10,132,255,.2)">${gList.map(gl=>`<option${gl===m.g?' selected':''}>${gl}</option>`).join('')}</select>
    </div>`;
    d.querySelector('select').onchange=e=>{mods[i].g=e.target.value; buildGPA();};
    w.appendChild(d);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const POIS=[
  {id:1,name:"Finance Section",cat:"Finance",icon:"ğŸ’³",xP:14.5,yP:43.5,status:"OPEN",hours:"Monâ€“Fri 09:00â€“15:00",desc:"Tuition fees, payments.",subOffices:["Cashier","Scholarship Desk","Refunds"],history:["09:00 OPEN"]},
  {id:2,name:"CPDC & Staff Club",cat:"Services",icon:"ğŸ“˜",xP:13.5,yP:37.5,status:"OPEN",hours:"Monâ€“Fri 08:30â€“16:30",desc:"CPDLL, Staff Club, Mini Canteen, MCB, Youth Friendly Services.",subOffices:["CPDLL","Staff Club","Mini Canteen","MCB"],history:["08:30 OPEN"]},
  {id:3,name:"Faculty of Agriculture â€” Phase I",cat:"Faculty",icon:"ğŸŒ±",xP:11.0,yP:46.5,status:"OPEN",hours:"Monâ€“Fri 08:00â€“17:00",desc:"Agriculture Phase I.",subOffices:["Lecture Rooms","Research Labs"],history:["08:00 OPEN"]},
  {id:4,name:"Faculty of Agriculture â€” Phase II",cat:"Faculty",icon:"ğŸŒ¿",xP:10.5,yP:54.5,status:"OPEN",hours:"Monâ€“Fri 08:00â€“17:00",desc:"Agriculture Phase II.",subOffices:["Greenhouse","Soil Lab"],history:["08:00 OPEN"]},
  {id:5,name:"R. Burrenchobay Lecture Theatre",cat:"Lecture",icon:"ğŸ“",xP:11.0,yP:62.0,status:"OPEN",hours:"Monâ€“Fri 07:30â€“18:00",desc:"Large capacity lecture theatre.",subOffices:["Main Hall","AV Booth"],history:["07:30 OPEN"]},
  {id:6,name:"Engineering Phase II & CITS",cat:"Faculty",icon:"ğŸ’¡",xP:20.0,yP:51.5,status:"OPEN",hours:"Monâ€“Fri 08:00â€“17:00",desc:"Eng Phase II, Stores, CITS.",subOffices:["Eng Phase II","Stores","CITS"],history:["08:00 OPEN"]},
  {id:7,name:"Faculty of Engineering â€” Phase I",cat:"Faculty",icon:"âš™ï¸",xP:13.0,yP:69.5,status:"OPEN",hours:"Monâ€“Fri 08:00â€“17:00",desc:"Engineering Phase I.",subOffices:["Mechanical Workshop","Civil Lab"],history:["08:00 OPEN"]},
  {id:8,name:"Faculty of Engineering â€” Phase III",cat:"Faculty",icon:"ğŸ—",xP:17.0,yP:77.5,status:"OPEN",hours:"Monâ€“Fri 08:00â€“17:00",desc:"Engineering Phase III.",subOffices:["Advanced Labs","Design Studio"],history:["08:00 OPEN"]},
  {id:9,name:"Food Kiosk",cat:"Food",icon:"ğŸ”",xP:14.5,yP:73.5,status:"OPEN",hours:"Monâ€“Fri 07:30â€“15:00",desc:"On-campus food kiosk.",subOffices:["Hot Food","Beverages"],history:["07:30 OPEN"]},
  {id:10,name:"Sir Edward Lim Fat Engineering Tower",cat:"Faculty",icon:"ğŸ¢",xP:11.5,yP:83.0,status:"OPEN",hours:"Monâ€“Fri 08:00â€“17:00",desc:"Engineering Tower â€” Admissions & Student Records.",subOffices:["Faculty of Engineering","Admissions","Student Records"],history:["08:00 OPEN"]},
  {id:11,name:"Faculty of Social Studies & Humanities",cat:"Faculty",icon:"ğŸŒ",xP:18.5,yP:67.5,status:"OPEN",hours:"Monâ€“Fri 08:30â€“16:30",desc:"Social Studies & Humanities.",subOffices:["Sociology","Economics","Politics"],history:["08:30 OPEN"]},
  {id:12,name:"Library, CAI & UoM Press",cat:"Library",icon:"ğŸ“š",xP:22.5,yP:56.0,status:"OPEN",hours:"Monâ€“Fri 08:00â€“20:00",desc:"Main Library, CAI, UoM Press.",subOffices:["Silent Study","Group Rooms","Digital Resources","UoM Press"],history:["08:00 OPEN"]},
  {id:13,name:"Computer Lab & First Aid",cat:"Services",icon:"ğŸ’»",xP:16.5,yP:40.5,status:"OPEN",hours:"Monâ€“Fri 08:00â€“17:00",desc:"GP Computer Lab, VCILT, First Aid.",subOffices:["Computer Lab","VCILT","First Aid"],history:["08:00 OPEN"]},
  {id:14,name:"Paul Octave WiÃ©he Auditorium",cat:"Services",icon:"ğŸ­",xP:35.0,yP:33.0,status:"QUIET",hours:"By booking only",desc:"Main auditorium â€” events and ceremonies.",subOffices:["Main Hall","Green Room","AV Control"],history:["QUIET"]},
  {id:15,name:"Information Kiosk",cat:"Services",icon:"â„¹ï¸",xP:31.5,yP:19.5,status:"OPEN",hours:"Monâ€“Fri 08:00â€“17:00",desc:"Main campus info kiosk.",subOffices:["Visitor Reception"],history:["08:00 OPEN"]},
  {id:16,name:"Student Centre, Cafeteria & SBM",cat:"Food",icon:"ğŸ½",xP:34.0,yP:44.0,status:"BUSY",hours:"Monâ€“Fri 07:30â€“16:00",desc:"Cafeteria, Photocopy, SBM.",subOffices:["Cafeteria","Photocopy","SBM","Student Lounge"],liveMsg:"Queue ~10 min",history:["BUSY â€” lunch peak"]},
  {id:17,name:"Lecture Theatres I & II",cat:"Lecture",icon:"ğŸ“",xP:29.5,yP:49.5,status:"BUSY",hours:"Monâ€“Fri 07:30â€“18:00",desc:"LT-I and LT-II.",subOffices:["LT-I","LT-II","AV Room"],liveMsg:"Lectures ongoing",history:["BUSY â€” lectures"]},
  {id:18,name:"Lecture Hall 1",cat:"Lecture",icon:"ğŸ“–",xP:33.0,yP:52.5,status:"OPEN",hours:"Monâ€“Fri 07:30â€“18:00",desc:"Lecture Hall 1.",subOffices:["LH-1"],history:["08:00 OPEN"]},
  {id:19,name:"Lecture Hall 2",cat:"Lecture",icon:"ğŸ“–",xP:31.5,yP:56.0,status:"OPEN",hours:"Monâ€“Fri 07:30â€“18:00",desc:"Lecture Hall 2.",subOffices:["LH-2"],history:["08:00 OPEN"]},
  {id:20,name:"Tower Block Building â€” NAC",cat:"Admin",icon:"ğŸ›",xP:32.5,yP:61.5,status:"OPEN",hours:"Monâ€“Fri 08:00â€“17:00",desc:"Central Admin, Faculty of Science, Law & Management.",subOffices:["Reception","Central Admin","Faculty of Science","Law & Management"],history:["08:00 OPEN"]},
  {id:21,name:"Covered Raised Plaza",cat:"Services",icon:"ğŸŒ³",xP:37.0,yP:60.0,status:"OPEN",hours:"Always open",desc:"Outdoor gathering space.",subOffices:["Seating","Notice Boards"],history:["Always open"]},
  {id:22,name:"Multipurpose Gymnasium",cat:"Sports",icon:"ğŸ‹ï¸",xP:70.0,yP:47.0,status:"OPEN",hours:"Monâ€“Sat 07:00â€“21:00",desc:"Sports hall and fitness.",subOffices:["Sports Hall","Fitness Room","Changing Rooms"],history:["07:00 OPEN"]},
  {id:23,name:"Football Playground",cat:"Sports",icon:"âš½",xP:66.5,yP:30.0,status:"OPEN",hours:"Monâ€“Sat 07:00â€“20:00",desc:"Football pitch.",subOffices:["Main Pitch","Changing Rooms"],history:["07:00 OPEN"]},
];

const sCfg={
  OPEN:{c:'#30d158',bg:'rgba(48,209,88,.12)'},
  CLOSED:{c:'#ff453a',bg:'rgba(255,69,58,.12)'},
  BUSY:{c:'#ffd60a',bg:'rgba(255,214,10,.12)'},
  QUIET:{c:'#5ac8fa',bg:'rgba(90,200,250,.12)'},
  UNKNOWN:{c:'#636366',bg:'rgba(99,99,102,.12)'}
};
const catC2={Admin:'#bf5af2',Faculty:'#0a84ff',Library:'#5ac8fa',Food:'#30d158',Sports:'#ffd60a',Services:'#5ac8fa',Finance:'#ff375f',Lecture:'#ff9f0a'};

const CW=960, CH=742;
let msc=1, mtx=0, mty=0, mdrg=false, msx=0, msy=0, mstx=0, msty=0;
let rFrom=null, rTo=null, admLog=[], mapCurPOI=null, mapFilter='All';

function pxFromPct(p){ return {x:p.xP/100*CW, y:p.yP/100*CH}; }

function initMap(){
  const c=document.getElementById('mc');
  c.width=CW; c.height=CH;
  drawMap(c.getContext('2d'));
  resetMap();
  renderPins();

  // populate admin POI select
  const sel=document.getElementById('admpoi');
  sel.innerHTML=POIS.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');

  // search
  const si=document.getElementById('msi'), sr=document.getElementById('msr');
  si.oninput=()=>{
    const q=si.value.toLowerCase().trim();
    sr.innerHTML='';
    if(!q){sr.classList.remove('on');return;}
    const hits=POIS.filter(p=>
      p.name.toLowerCase().includes(q)||
      p.cat.toLowerCase().includes(q)||
      (p.subOffices||[]).some(s=>s.toLowerCase().includes(q))
    ).slice(0,6);
    if(!hits.length){sr.classList.remove('on');return;}
    sr.innerHTML=hits.map(p=>`<div class="msri" data-pid="${p.id}"><span>${p.icon}</span><div><div style="font-size:14px;font-weight:500">${p.name}</div><div style="font-size:12px;color:var(--muted)">${p.cat}</div></div></div>`).join('');
    sr.classList.add('on');
    sr.querySelectorAll('.msri').forEach(el=>{
      el.addEventListener('click',()=>{
        const poi=POIS.find(x=>x.id==el.dataset.pid);
        if(poi){locatePOI(poi); si.value=poi.name; sr.classList.remove('on');}
      });
    });
  };

  document.addEventListener('click',e=>{
    if(!e.target.closest('#ms-wrap')) sr.classList.remove('on');
  });

  // filter buttons
  document.getElementById('mf').addEventListener('click',e=>{
    const b=e.target.closest('[data-mc]'); if(!b)return;
    document.querySelectorAll('[data-mc]').forEach(x=>x.classList.remove('on'));
    b.classList.add('on'); mapFilter=b.dataset.mc; renderPins();
  });

  // drag
  const mw=document.getElementById('mw');
  mw.addEventListener('mousedown',e=>{
    if(e.target.closest('.pin')||e.target.closest('#mbs')||e.target.closest('#mctrl')||
       e.target.closest('#ms-wrap')||e.target.closest('#mf')||e.target.closest('#rbar')||e.target.closest('#adm')) return;
    mdrg=true; msx=e.clientX; msy=e.clientY; mstx=mtx; msty=mty; mw.classList.add('drg');
  });
  window.addEventListener('mousemove',e=>{
    if(!mdrg)return;
    mtx=mstx+(e.clientX-msx); mty=msty+(e.clientY-msy); applyT();
  });
  window.addEventListener('mouseup',()=>{mdrg=false; document.getElementById('mw').classList.remove('drg');});

  mw.addEventListener('touchstart',e=>{
    if(e.touches.length===1){
      const t=e.touches[0]; mdrg=true;
      msx=t.clientX; msy=t.clientY; mstx=mtx; msty=mty;
    }
  },{passive:true});
  mw.addEventListener('touchmove',e=>{
    if(!mdrg||e.touches.length!==1)return;
    const t=e.touches[0];
    mtx=mstx+(t.clientX-msx); mty=msty+(t.clientY-msy); applyT();
  },{passive:true});
  mw.addEventListener('touchend',()=>mdrg=false);

  mw.addEventListener('wheel',e=>{
    e.preventDefault();
    const r=document.getElementById('mw').getBoundingClientRect();
    dz(e.deltaY<0?1.12:.9, e.clientX-r.left, e.clientY-r.top);
  },{passive:false});

  mw.addEventListener('click',e=>{
    if(!e.target.closest('.pin')&&!e.target.closest('#mbs')) closeMBS();
  });
}

function drawMap(ctx){
  // base green (grass/ground)
  ctx.fillStyle='#7aaa5a'; ctx.fillRect(0,0,CW,CH);

  // roads
  ctx.fillStyle='#9e9080';
  ctx.fillRect(0,65,CW,52);       // top road
  ctx.fillRect(800,0,80,420);     // right road
  ctx.fillRect(0,690,CW,52);      // bottom road
  ctx.fillRect(0,300,100,420);    // left edge road
  ctx.fillRect(100,380,80,340);
  ctx.fillRect(200,250,42,520);   // inner road vertical
  ctx.fillRect(240,390,300,38);   // inner road horizontal
  ctx.fillRect(860,0,60,742);     // far right

  // roundabout
  ctx.strokeStyle='#9e9080'; ctx.lineWidth=40;
  ctx.beginPath(); ctx.arc(200,117,55,0,Math.PI*2); ctx.stroke();
  ctx.fillStyle='#7aaa5a';
  ctx.beginPath(); ctx.arc(200,117,35,0,Math.PI*2); ctx.fill();

  // car parks
  [[295,168,80,45],[460,168,90,45],[515,285,95,55],[735,285,60,55],[755,330,60,40],[120,415,55,35]].forEach(([x,y,w,h])=>{
    ctx.fillStyle='#c8bfb0'; ctx.fillRect(x,y,w,h);
    ctx.strokeStyle='#aaa'; ctx.lineWidth=1; ctx.strokeRect(x,y,w,h);
    for(let i=10;i<w;i+=12){ctx.beginPath();ctx.moveTo(x+i,y+3);ctx.lineTo(x+i,y+h-3);ctx.stroke();}
    ctx.fillStyle='rgba(0,0,0,.5)';
    ctx.font='bold 11px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText('P',x+w/2,y+h/2);
  });

  // buildings
  const B=[
    [296,195,135,105,'#e8a020','14'],[300,300,70,70,'#e8a020','16'],
    [508,308,260,100,'#5ca830','23'],[508,415,260,90,'#e8a020','22'],
    [48,380,68,60,'#d4a020','2'],[38,415,48,50,'#c89020','3'],
    [38,460,48,60,'#c89020','4'],[38,520,55,50,'#c89020','5'],
    [105,345,60,50,'#e05050','13'],[85,395,50,40,'#cc3030','1'],
    [48,565,75,60,'#f0c030','7'],[95,620,70,65,'#f0c030','8'],
    [38,635,52,65,'#f0c030','9\n10'],[165,455,80,60,'#cc88dd','12'],
    [165,395,65,55,'#cc66cc','6'],[172,518,60,52,'#b86aaa','11'],
    [235,430,60,55,'#5566cc','17'],[255,462,55,48,'#4455bb','18'],
    [240,492,58,48,'#3344aa','19'],[255,525,85,70,'#6644bb','20'],
    [295,488,60,50,'#7755cc','21'],[340,200,28,28,'#888','15']
  ];
  B.forEach(([x,y,w,h,col,lbl])=>{
    ctx.fillStyle='rgba(0,0,0,.15)'; ctx.fillRect(x+3,y+3,w,h);
    ctx.fillStyle=col; ctx.fillRect(x,y,w,h);
    ctx.strokeStyle='rgba(0,0,0,.22)'; ctx.lineWidth=1.5; ctx.strokeRect(x,y,w,h);
    const lines=lbl.split('\n');
    const fs=Math.min(13,w/(lbl.replace('\n','').length*.6)+2);
    ctx.fillStyle='rgba(255,255,255,.85)';
    ctx.font=`bold ${fs}px system-ui`; ctx.textAlign='center'; ctx.textBaseline='middle';
    lines.forEach((l,i)=>ctx.fillText(l,x+w/2,y+h/2+(i-(lines.length-1)/2)*fs*1.3));
  });

  // campus paths
  ctx.strokeStyle='#e8952a'; ctx.lineWidth=8; ctx.lineCap='round';
  [[200,390,300,390],[300,390,300,300],[300,390,300,500],[300,500,480,500]].forEach(([x1,y1,x2,y2])=>{
    ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
  });

  // metro line
  ctx.strokeStyle='#7c3aed'; ctx.lineWidth=10; ctx.setLineDash([18,9]);
  ctx.beginPath(); ctx.moveTo(875,65); ctx.lineTo(875,420); ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle='#7c3aed'; ctx.fillRect(850,260,50,30);
  ctx.fillStyle='#fff'; ctx.font='bold 10px system-ui'; ctx.textAlign='center';
  ctx.fillText('Metro',875,280);

  // bus stop
  ctx.fillStyle='#0a84ff'; ctx.fillRect(290,68,70,22);
  ctx.fillStyle='#fff'; ctx.font='bold 10px system-ui';
  ctx.fillText('Bus Stop',325,82);

  // direction labels
  ctx.fillStyle='rgba(0,0,0,.5)'; ctx.font='bold 11px system-ui'; ctx.textAlign='left';
  ctx.fillText('â†’ To RÃ©duit',420,58);
  ctx.fillText('To P. Louis â†‘',820,55);
  ctx.fillText('â†’ To Moka',890,95);

  // compass
  ctx.fillStyle='rgba(0,0,0,.55)'; ctx.font='bold 12px system-ui'; ctx.textAlign='center';
  ctx.fillText('N',38,125); ctx.fillText('S',38,168);
  ctx.strokeStyle='rgba(0,0,0,.55)'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(38,132); ctx.lineTo(38,162); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(33,140); ctx.lineTo(38,132); ctx.lineTo(43,140); ctx.stroke();

  // dark overlay for depth
  ctx.fillStyle='rgba(0,4,15,.44)'; ctx.fillRect(0,0,CW,CH);

  // legend
  ctx.fillStyle='rgba(7,13,31,.85)'; roundRect(ctx,8,CH-68,180,60,10); ctx.fill();
  ctx.strokeStyle='rgba(255,255,255,.1)'; ctx.lineWidth=.5; roundRect(ctx,8,CH-68,180,60,10); ctx.stroke();
  const leg=[['#0a84ff','Bus Stop'],['#7c3aed','Metro Line'],['#e8952a','Campus Path']];
  ctx.font='bold 10px system-ui'; ctx.textAlign='left';
  leg.forEach(([c,l],i)=>{
    ctx.fillStyle=c; ctx.fillRect(16,CH-56+i*17,14,10);
    ctx.fillStyle='rgba(255,255,255,.7)'; ctx.fillText(l,35,CH-48+i*17);
  });
}

function roundRect(ctx,x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y); ctx.arcTo(x+w,y,x+w,y+r,r);
  ctx.lineTo(x+w,y+h-r); ctx.arcTo(x+w,y+h,x+w-r,y+h,r);
  ctx.lineTo(x+r,y+h); ctx.arcTo(x,y+h,x,y+h-r,r);
  ctx.lineTo(x,y+r); ctx.arcTo(x,y,x+r,y,r); ctx.closePath();
}

function applyT(){
  const mc=document.getElementById('mc');
  const mw=document.getElementById('mw');
  const maxX=0, minX=mw.clientWidth-CW*msc;
  const maxY=0, minY=mw.clientHeight-CH*msc;
  mtx=Math.max(minX,Math.min(maxX,mtx));
  mty=Math.max(minY,Math.min(maxY,mty));
  mc.style.transform=`translate(${mtx}px,${mty}px) scale(${msc})`;
  document.getElementById('rsvg').style.transform=`translate(${mtx}px,${mty}px) scale(${msc})`;
  renderPins();
}

function dz(factor, cx, cy){
  const mw=document.getElementById('mw');
  if(cx===undefined) cx=mw.clientWidth/2;
  if(cy===undefined) cy=mw.clientHeight/2;
  const ns=Math.max(.3,Math.min(3,msc*factor));
  mtx=cx-(cx-mtx)*ns/msc;
  mty=cy-(cy-mty)*ns/msc;
  msc=ns;
  applyT();
}

function resetMap(){
  const mw=document.getElementById('mw');
  const scx=mw.clientWidth/CW, scy=mw.clientHeight/CH;
  msc=Math.min(scx,scy)*.98;
  mtx=(mw.clientWidth-CW*msc)/2;
  mty=(mw.clientHeight-CH*msc)/2;
  applyT();
}

function renderPins(){
  // remove old pins
  document.querySelectorAll('.pin').forEach(p=>p.remove());
  const mw=document.getElementById('mw');
  const visible=mapFilter==='All'?POIS:POIS.filter(p=>p.cat===mapFilter);
  visible.forEach(poi=>{
    const pos=pxFromPct(poi);
    const sc=sCfg[poi.status]||sCfg.UNKNOWN;
    const cc=catC2[poi.cat]||'#4facfe';
    const pin=document.createElement('div');
    pin.className='pin'+(mapCurPOI&&mapCurPOI.id===poi.id?' act':'');
    pin.style.left=(pos.x*msc+mtx)+'px';
    pin.style.top=(pos.y*msc+mty)+'px';
    pin.innerHTML=`<div class="pb" style="background:${sc.bg};border-color:${sc.c}40"><span>${poi.icon}</span></div><div class="pt" style="background:${sc.c}"></div>`;
    pin.addEventListener('click',e=>{e.stopPropagation(); openMBS(poi);});
    mw.appendChild(pin);
  });
}

function openMBS(poi){
  mapCurPOI=poi;
  renderPins();
  const sc=sCfg[poi.status]||sCfg.UNKNOWN;
  const cc=catC2[poi.cat]||'#4facfe';
  const subOff=(poi.subOffices||[]).map(s=>`<span style="background:rgba(255,255,255,.05);border:.5px solid rgba(255,255,255,.1);color:var(--text2);font-size:11px;font-weight:500;padding:3px 10px;border-radius:999px">${s}</span>`).join('');
  document.getElementById('mbsc').innerHTML=`
    <div style="display:flex;gap:12px;align-items:flex-start;margin-bottom:14px">
      <div style="width:48px;height:48px;border-radius:14px;background:${sc.bg};border:.5px solid ${sc.c}40;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0">${poi.icon}</div>
      <div style="flex:1">
        <div style="font-size:17px;font-weight:700;color:var(--text);letter-spacing:-.3px;line-height:1.2">${poi.name}</div>
        <div style="font-size:12px;color:var(--muted);margin-top:2px">${poi.cat}</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap">
      <span style="background:${sc.bg};color:${sc.c};border:.5px solid ${sc.c}40;font-size:12px;font-weight:700;padding:4px 12px;border-radius:999px">${poi.status}</span>
      <span style="color:var(--muted);font-size:13px">ğŸ• ${poi.hours}</span>
    </div>
    ${poi.liveMsg?`<div style="background:rgba(255,214,10,.08);border:.5px solid rgba(255,214,10,.25);border-radius:10px;padding:8px 12px;margin-bottom:12px;font-size:13px;color:#ffd60a">ğŸ“¢ ${poi.liveMsg}</div>`:''}
    <div style="font-size:13px;color:var(--muted);line-height:1.5;margin-bottom:12px">${poi.desc}</div>
    ${subOff?`<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px">${subOff}</div>`:''}
    <div style="display:flex;gap:8px">
      <button class="pbtn" style="flex:1;border-radius:12px;padding:11px" onclick="startRoute(${poi.id})">ğŸ§­ Get Route</button>
      <button class="sbtn" style="flex:1;border-radius:12px;padding:11px" onclick="setRouteFrom(${poi.id})">ğŸ“ Set From</button>
    </div>
  `;
  document.getElementById('mbs').classList.add('on');
}

function closeMBS(){
  document.getElementById('mbs').classList.remove('on');
  mapCurPOI=null;
  renderPins();
}

function setRouteFrom(id){
  rFrom=POIS.find(p=>p.id===id);
  toast(`ğŸ“ From: ${rFrom.name}`);
  closeMBS();
}

function startRoute(toId){
  rTo=POIS.find(p=>p.id===toId);
  if(!rFrom){
    // pick a default start (e.g., Info Kiosk)
    rFrom=POIS.find(p=>p.id===15)||POIS[0];
  }
  drawRoute();
  closeMBS();
}

function drawRoute(){
  if(!rFrom||!rTo)return;
  const svg=document.getElementById('rsvg');
  const p1=pxFromPct(rFrom), p2=pxFromPct(rTo);
  // straight-line distance in "map units"
  const dx=p2.x-p1.x, dy=p2.y-p1.y;
  const dist=Math.sqrt(dx*dx+dy*dy);
  // estimate ~1 pixel â‰ˆ 0.5m on the map
  const metres=Math.round(dist*0.5);
  const mins=Math.max(1,Math.round(metres/80));
  // draw line
  svg.innerHTML=`
    <defs>
      <marker id="arr" markerWidth="8" markerHeight="8" refX="4" refY="4" orient="auto">
        <path d="M0,0 L8,4 L0,8 Z" fill="#0a84ff"/>
      </marker>
    </defs>
    <line x1="${p1.x}" y1="${p1.y}" x2="${p2.x}" y2="${p2.y}"
      stroke="#0a84ff" stroke-width="3" stroke-dasharray="8,5"
      marker-end="url(#arr)" opacity="0.9"/>
    <circle cx="${p1.x}" cy="${p1.y}" r="7" fill="#30d158" stroke="#fff" stroke-width="2"/>
    <circle cx="${p2.x}" cy="${p2.y}" r="7" fill="#ff453a" stroke="#fff" stroke-width="2"/>
  `;
  document.getElementById('rdist').textContent=metres<1000?`${metres}m`:`${(metres/1000).toFixed(1)}km`;
  document.getElementById('rtime').textContent=`~${mins} min`;
  document.getElementById('rbar').classList.add('on');
}

function clearRoute(){
  rFrom=null; rTo=null;
  document.getElementById('rsvg').innerHTML='';
  document.getElementById('rbar').classList.remove('on');
}

function locatePOI(poi){
  const mw=document.getElementById('mw');
  const pos=pxFromPct(poi);
  const cx=mw.clientWidth/2, cy=mw.clientHeight/2;
  mtx=cx-pos.x*msc;
  mty=cy-pos.y*msc;
  applyT();
  setTimeout(()=>openMBS(poi),150);
}

// Admin panel
function openAdm(){
  document.getElementById('adm').classList.add('on');
  renderAdmLog();
}
function closeAdm(){document.getElementById('adm').classList.remove('on');}

function saveAdm(){
  const pid=parseInt(document.getElementById('admpoi').value);
  const stat=document.getElementById('admstat').value;
  const msg=document.getElementById('admmsg').value.trim();
  const tw=document.getElementById('admtw').value.trim();
  const poi=POIS.find(p=>p.id===pid);
  if(!poi)return;
  poi.status=stat;
  if(msg) poi.liveMsg=msg; else delete poi.liveMsg;
  const ts=new Date().toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
  poi.history.unshift(`${ts} â†’ ${stat}${tw?' ('+tw+')':''}${msg?' â€” '+msg:''}`);
  admLog.unshift({ts,name:poi.name,stat,msg,tw});
  renderAdmLog();
  renderPins();
  toast('âœ… Status updated!');
  document.getElementById('admmsg').value='';
  document.getElementById('admtw').value='';
}

function renderAdmLog(){
  const el=document.getElementById('admlog');
  if(!admLog.length){el.innerHTML='<div style="color:var(--muted);font-size:13px">No updates yet</div>';return;}
  el.innerHTML=admLog.slice(0,6).map(l=>{
    const sc=sCfg[l.stat]||sCfg.UNKNOWN;
    return `<div style="background:rgba(255,255,255,.03);border:.5px solid rgba(255,255,255,.07);border-radius:10px;padding:10px 12px;margin-bottom:7px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:3px">
        <span style="color:var(--text);font-size:13px;font-weight:500">${l.name}</span>
        <span style="background:${sc.bg};color:${sc.c};font-size:10px;font-weight:700;padding:2px 8px;border-radius:999px">${l.stat}</span>
      </div>
      <div style="color:var(--muted);font-size:12px">${l.ts}${l.tw?' Â· '+l.tw:''}${l.msg?' Â· '+l.msg:''}</div>
    </div>`;
  }).join('');
}
</script>
</body>
</html>